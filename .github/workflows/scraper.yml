name: Run BTC Scraper (Cached clean)

on:
  workflow_dispatch:

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Debug GSPREAD_JSON
        run: echo "${{ secrets.GSPREAD_JSON }}" | head -n 5

      - name: Cache Chrome packages
        id: apt-cache
        uses: actions/cache@v3
        with:
          path: .apt-cache
          key: ${{ runner.os }}-apt-${{ hashFiles('apt-packages.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install Chrome + Chromedriver (cached)
        run: |
          echo "google-chrome-stable" > apt-packages.txt
          echo "chromium-chromedriver" >> apt-packages.txt

          mkdir -p .apt-cache
          sudo apt-get update
          # Download only (no root-owned lock files in cache)
          sudo apt-get -o dir::cache::archives="$(pwd)/.apt-cache" install --download-only -y $(cat apt-packages.txt)
          # Install from cached debs
          sudo dpkg -i .apt-cache/*.deb || sudo apt-get -f install -y
          sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run script
        env:
          GSPREAD_JSON: ${{ secrets.GSPREAD_JSON }}
        run: python scraper.py
