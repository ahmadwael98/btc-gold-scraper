name: Run BTC Scraper (Cached)

on:
  workflow_dispatch:

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        cache: "pip"   # âœ… caches python deps

    - name: Debug GSPREAD_JSON
      run: echo "${{ secrets.GSPREAD_JSON }}" | head -n 5

    - name: Cache Chrome packages
      uses: actions/cache@v3
      with:
        path: .apt-cache
        key: ${{ runner.os }}-apt-${{ hashFiles('apt-packages.txt') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install Chrome + Chromedriver
      run: |
        echo "google-chrome-stable" > apt-packages.txt
        echo "chromium-chromedriver" >> apt-packages.txt

        mkdir -p .apt-cache
        sudo apt-get update
        sudo apt-get -o dir::cache::archives="$(pwd)/.apt-cache" install -y $(cat apt-packages.txt)
        sudo ln -s /usr/bin/chromedriver /usr/local/bin/chromedriver

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run script
      env:
        GSPREAD_JSON: ${{ secrets.GSPREAD_JSON }}
      run: python scraper.py
